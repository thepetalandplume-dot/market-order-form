<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Order Form - Quick Entry</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Load HEIC to JPEG converter library -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.15/dist/heic2any.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f6f8;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            transition: all 0.15s ease-in-out;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex justify-center min-h-screen">

<div id="app" class="w-full max-w-lg">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Custom Order Form</h1>
        <p class="text-gray-500">Scan. Submit. Customize. (Order ID: <span id="orderIdDisplay" class="font-mono text-xs text-indigo-500">...</span>)</p>
    </header>

    <!-- STEP 1: Form Input -->
    <div id="step-form" class="card bg-white p-6 rounded-xl space-y-6">

        <h2 class="text-xl font-semibold text-gray-700 border-b pb-3 mb-4">Customer Details</h2>

        <div>
            <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Your Name *</label>
            <input type="text" id="customerName" placeholder="Jane Doe" required
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
        </div>

        <div>
            <label for="customerPhone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
            <input type="tel" id="customerPhone" placeholder="123-456-7890" required
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
        </div>

        <div>
            <label for="customerEmail" class="block text-sm font-medium text-gray-700 mb-1">Email (Optional)</label>
            <input type="email" id="customerEmail" placeholder="jane@example.com"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
        </div>

        <h2 class="text-xl font-semibold text-gray-700 border-b pb-3 mb-4 mt-6">Order Details</h2>

        <div>
            <label for="itemsRequested" class="block text-sm font-medium text-gray-700 mb-1">Customization/Item Request *</label>
            <textarea id="itemsRequested" rows="4" placeholder="Describe what you want customized (e.g., '1 leather patch with a dog's name, font style: bold script', 'Two personalized keychains: one red, one blue')." required
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
        </div>

        <div class="space-y-2">
            <label for="photoUpload" class="block text-sm font-medium text-gray-700">Upload Reference Photos (HEIC/JPEG/PNG)</label>
            <p class="text-xs text-gray-500">Photos will be saved directly for you to download!</p>
            <input type="file" id="photoUpload" multiple accept="image/*,.heic,.heif"
                   class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none p-2">
            <div id="loadingIndicator" class="hidden p-3 mt-2 bg-indigo-100 text-indigo-700 rounded-lg font-semibold">
                <div class="flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Processing and uploading images...
                </div>
            </div>
            <div id="errorBox" class="hidden p-3 mt-2 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm"></div>
        </div>

        <button onclick="handleSubmission()" id="submitButton" class="btn-primary w-full py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
            Save Order & View Payment Options
        </button>
    </div>

    <!-- STEP 2: Confirmation and Payment -->
    <div id="step-confirmation" class="card bg-white p-6 rounded-xl space-y-6 hidden">
        <h2 class="text-2xl font-bold text-green-600">âœ… Order Saved & Submitted!</h2>
        <p class="text-gray-700">Your details and photos have been securely saved. Please confirm the payment with the links below.</p>

        <h3 class="text-xl font-semibold text-gray-700 border-b pb-2">Order Summary</h3>
        <div id="summaryContent" class="space-y-2 text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">
            <!-- Summary will be populated here -->
        </div>

        <h3 class="text-xl font-semibold text-gray-700 border-b pb-2 mt-6">Reference Photo Preview (<span id="fileCount">0</span> images)</h3>
        <div id="imagePreview" class="grid grid-cols-2 gap-4">
            <!-- Images will be populated here -->
        </div>

        <h3 class="text-xl font-semibold text-gray-700 border-b pb-2 mt-6">Payment Options</h3>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <a id="paypalLink" target="_blank" class="btn-primary flex items-center justify-center py-3 bg-blue-700 text-white rounded-lg font-semibold hover:bg-blue-800">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2">
                    <path d="M11.594 1.406C5.973 1.406 1.406 5.973 1.406 11.594c0 5.621 4.567 10.188 10.188 10.188s10.188-4.567 10.188-10.188c0-5.621-4.567-10.188-10.188-10.188zM8.375 14.875c-0.108 0.003-0.207-0.038-0.283-0.114-0.198-0.197-0.347-0.563-0.457-0.999-0.09-0.353-0.14-0.707-0.14-1.077 0-0.334 0.046-0.655 0.137-0.957 0.088-0.297 0.208-0.596 0.359-0.902 0.151-0.306 0.338-0.602 0.564-0.891 0.226-0.289 0.495-0.567 0.812-0.824 0.316-0.257 0.686-0.485 1.111-0.672s0.879-0.342 1.396-0.461c0.518-0.12 1.078-0.19 1.679-0.19h3.75c0.354 0 0.625 0.271 0.625 0.625v2.812c0 0.354-0.271 0.625-0.625 0.625h-3.125c-0.413 0-0.803 0.108-1.164 0.323-0.36 0.215-0.648 0.528-0.864 0.941-0.216 0.412-0.323 0.893-0.323 1.442s0.107 1.03 0.323 1.442c0.216 0.412 0.504 0.725 0.864 0.941 0.361 0.215 0.751 0.323 1.164 0.323h3.125c0.354 0 0.625 0.271 0.625 0.625v2.812c0 0.354-0.271 0.625-0.625 0.625h-3.75c-0.601 0-1.161-0.07-1.679-0.19s-1.079-0.347-1.396-0.467c-0.517-0.12-0.879-0.348-1.111-0.671-0.317-0.257-0.586-0.536-0.812-0.824-0.226-0.29-0.413-0.585-0.564-0.891-0.151-0.306-0.271-0.605-0.359-0.902-0.09-0.302-0.137-0.623-0.137-0.957 0-0.365 0.05-0.719 0.14-1.077 0.11-0.436 0.26-0.803 0.457-0.999 0.076-0.076 0.175-0.117 0.283-0.114z"/>
                </svg>
                Pay with PayPal
            </a>
            <a id="venmoLink" target="_blank" class="btn-primary flex items-center justify-center py-3 bg-sky-500 text-white rounded-lg font-semibold hover:bg-sky-600">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2">
                    <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zM12 1.75c5.656 0 10.25 4.594 10.25 10.25S17.656 22.25 12 22.25 1.75 17.656 1.75 12 6.344 1.75 12 1.75zM12 4.125c-1.35 0-2.614 0.54-3.522 1.455-0.893 0.893-1.453 2.157-1.453 3.518 0 1.259 0.436 2.457 1.229 3.424 0.751 0.923 1.777 1.48 2.923 1.543v1.656h-2.125c-0.237 0-0.433 0.196-0.433 0.433s0.196 0.433 0.433 0.433h4.688c0.237 0 0.433-0.196 0.433-0.433s-0.196-0.433-0.433-0.433h-2.125v-1.656c1.146-0.063 2.172-0.62 2.923-1.543 0.793-0.967 1.229-2.165 1.229-3.424 0-1.361-0.56-2.625-1.453-3.518C14.614 4.665 13.35 4.125 12 4.125zm0 1.094c2.81 0 5.156 2.346 5.156 5.156 0 2.81-2.346 5.156-5.156 5.156-2.81 0-5.156-2.346-5.156-5.156 0-2.81 2.346-5.156 5.156-5.156z"/>
                </svg>
                Pay with Venmo
            </a>
        </div>

        <button onclick="resetForm()" class="w-full py-2 text-sm text-gray-500 hover:text-gray-700 mt-4">
            Start a New Order
        </button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // --- CONFIGURATION (REPLACE THESE) ---
    // !!! IMPORTANT: Update these links with your PayPal and Venmo URLs !!!
    const PAYPAL_LINK = "https://paypal.me/thepetalandplume"; 
    const VENMO_LINK = "https://venmo.com/thepetalandplume"; 
    const COLLECTION_NAME = "market_orders";

    // Global Firebase variables
    let db;
    let auth;
    let storage;
    let vendorUserId = 'unknown';

    // Set PayPal and Venmo links once the document is ready
    document.getElementById('paypalLink').href = PAYPAL_LINK;
    document.getElementById('venmoLink').href = VENMO_LINK;
    
    // Use the global variables provided by the environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Initialize Firebase and Authenticate
    async function initFirebase() {
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is missing. Data persistence will fail.");
            document.getElementById('errorBox').textContent = 'Error: Firebase configuration missing. Cannot save orders.';
            document.getElementById('errorBox').classList.remove('hidden');
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app); // Initialize Firebase Storage
            setLogLevel('Debug');

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    vendorUserId = user.uid;
                    console.log("Firebase initialized. Vendor User ID:", vendorUserId);
                } else {
                    console.error("Authentication failed. Cannot get vendor user ID.");
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('errorBox').textContent = `Firebase Error: ${error.message}`;
            document.getElementById('errorBox').classList.remove('hidden');
        }
    }

    // Call initialization on load
    initFirebase();


    // Function to handle image conversion, upload, and submission
    async function handleSubmission() {
        if (!db || !storage || !vendorUserId) {
            document.getElementById('errorBox').textContent = 'System initializing. Please wait a moment and try again.';
            document.getElementById('errorBox').classList.remove('hidden');
            return;
        }

        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        const email = document.getElementById('customerEmail').value.trim();
        const items = document.getElementById('itemsRequested').value.trim();
        const files = document.getElementById('photoUpload').files;
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorBox = document.getElementById('errorBox');
        const submitButton = document.getElementById('submitButton');

        // Basic Validation
        if (!name || !phone || !items) {
            errorBox.textContent = 'Please fill out all required fields (Name, Phone, Request).';
            errorBox.classList.remove('hidden');
            return;
        }

        errorBox.classList.add('hidden');
        loadingIndicator.classList.remove('hidden');
        submitButton.disabled = true;
        submitButton.classList.add('opacity-50', 'cursor-not-allowed');

        try {
            const uploadedImageUrls = [];
            const filesToDisplay = [];

            // 1. Process and Upload Images to Storage
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const isHeic = file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif');
                let processedFile = file;

                // Handle HEIC Conversion
                if (isHeic) {
                    const outputBlob = await heic2any({
                        blob: file,
                        toType: "image/jpeg",
                        quality: 0.9
                    });
                    processedFile = new File([outputBlob], `${name.replace(/\s/g, '_')}_ref_${i + 1}.jpeg`, {
                        type: "image/jpeg",
                        lastModified: Date.now()
                    });
                }
                
                // Add to display list
                filesToDisplay.push(processedFile);

                // Upload to Firebase Storage
                // Using a temporary ID, which is fine since we rely on the final download URL
                const tempId = Date.now(); 
                const path = `orders/${vendorUserId}/temp_uploads/${tempId}_${processedFile.name}`;
                const storageRef = ref(storage, path);
                
                await uploadBytes(storageRef, processedFile);
                const downloadURL = await getDownloadURL(storageRef);

                uploadedImageUrls.push({
                    name: processedFile.name,
                    url: downloadURL,
                });
            }

            // 2. Prepare Firestore Document
            const orderData = {
                customerName: name,
                customerPhone: phone,
                customerEmail: email,
                itemsRequested: items,
                timestamp: new Date(),
                isPaid: false,
                imageUrls: uploadedImageUrls, 
                vendorId: vendorUserId,
            };

            // 3. Save Order Data to Firestore
            const publicPath = `/artifacts/${appId}/public/data/${COLLECTION_NAME}`;
            const docRef = await addDoc(collection(db, publicPath), orderData);
            const finalOrderId = docRef.id;

            loadingIndicator.classList.add('hidden');

            // 4. Display Confirmation
            displayConfirmation(name, phone, email, items, filesToDisplay, finalOrderId);

        } catch (e) {
            console.error("Submission error:", e);
            errorBox.textContent = `Error saving order: ${e.message}. Please try again or check console for details.`;
            errorBox.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');
            submitButton.disabled = false;
            submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }

    // Function to display the confirmation screen
    function displayConfirmation(name, phone, email, items, files, orderId) {
        const summaryContent = document.getElementById('summaryContent');
        const imagePreview = document.getElementById('imagePreview');
        const fileCount = document.getElementById('fileCount');

        document.getElementById('orderIdDisplay').textContent = orderId;
        
        // Build Summary Content
        const summaryHTML = `
            <p><strong>Order ID:</strong> <span class="text-indigo-600">${orderId}</span></p>
            <p><strong>Name:</strong> ${name}</p>
            <p><strong>Phone:</strong> ${phone}</p>
            <p><strong>Email:</strong> ${email || 'Not Provided'}</p>
            <p><strong>Request:</strong></p>
            <p class="whitespace-pre-wrap pl-4 border-l-2 border-indigo-300">${items}</p>
        `;
        summaryContent.innerHTML = summaryHTML;
        
        // Build Image Previews
        imagePreview.innerHTML = '';
        fileCount.textContent = files.length;
        files.forEach(file => {
            // Use local object URL for immediate display
            const url = URL.createObjectURL(file); 
            const imgHtml = `
                <div class="rounded-lg overflow-hidden border border-gray-200">
                    <a href="${url}" target="_blank" class="block">
                        <img src="${url}" alt="Reference Photo" class="w-full h-32 object-cover">
                    </a>
                    <p class="text-xs text-center p-1 bg-gray-100 truncate">${file.name}</p>
                </div>
            `;
            imagePreview.insertAdjacentHTML('beforeend', imgHtml);
        });

        // Toggle Views
        document.getElementById('step-form').classList.add('hidden');
        document.getElementById('step-confirmation').classList.remove('hidden');
    }

    function resetForm() {
        // Clear all inputs and reset buttons
        document.getElementById('customerName').value = '';
        document.getElementById('customerPhone').value = '';
        document.getElementById('customerEmail').value = '';
        document.getElementById('itemsRequested').value = '';
        document.getElementById('photoUpload').value = '';
        document.getElementById('submitButton').disabled = false;
        document.getElementById('submitButton').classList.remove('opacity-50', 'cursor-not-allowed');

        // Toggle back to form view
        document.getElementById('step-confirmation').classList.add('hidden');
        document.getElementById('step-form').classList.remove('hidden');
        document.getElementById('imagePreview').innerHTML = '';
        document.getElementById('orderIdDisplay').textContent = '...';
    }
</script>

</body>
</html>
